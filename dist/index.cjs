function e(e,t,n){return t.reduce((e,t)=>{let r=n[t.type];return r?r(e,t):e},e)}function t(t,n,r){let{past:i,future:a}=t.history;if(i.length===0)return null;let o=i.at(-1),s=i.slice(0,-1);return{...e(n,s,r),history:{past:s,future:o?[o,...a]:a}}}function n(t,n,r){let{past:i,future:a}=t.history;if(a.length===0)return null;let o=a[0],s=a.slice(1);return{...e(n,[...i,o],r),history:{past:[...i,o],future:s}}}const r={undo:t,redo:n},i={record(e,t){let{past:n}=e;return{...e,past:[...n,t]}}},a=e=>{let{initialState:t,intentMap:n,debug:a,logger:o}=e,s=t,c=new Set;function l(){return s}function u(){for(let e of c)e(s)}function d(e){let t=n[e.type];if(!t)throw Error(`No intent found for command type ${e.type}`);let r=s,c=t(r,e);if(c===r)return;let l=e.meta?.recordHistory!==!1;s={...c,history:l?i.record(r.history,e):r.history},a&&o&&o(s,e),u()}function f(){let e=r.undo(s,t,n);e&&(s=e,a&&o&&o(s,void 0),u())}function p(){let e=r.redo(s,t,n);e&&(s=e,a&&o&&o(s,void 0),u())}function m(e){return c.add(e),()=>c.delete(e)}function h(e){s=e,a&&o&&o(s,void 0),u()}return{getState:l,dispatch:d,undo:f,redo:p,subscribe:m,replaceState:h}},o={addNode(e,t){if(e.nodes.has(t.id))return e;let n=new Map(e.nodes);return n.set(t.id,t),{...e,nodes:n}},removeNode(e,t){if(!e.nodes.has(t))throw Error(`Node with id ${t} does not exist`);let n=new Map(e.nodes);return n.delete(t),{...e,nodes:n}},removeNodes(e,t){let n=new Map(e.nodes);return t.forEach(e=>{n.delete(e)}),{...e,nodes:n}},updateNode(e,t,n){let r=e.nodes.get(t);if(!r)throw Error(`Node with id ${t} does not exist`);let i={...r,...n},a=new Map(e.nodes);return a.set(t,i),{...e,nodes:a}}},s={insertNode(e,t,n){let r=String(t);if(e.order.includes(r))return e;let i=e.order,a=n??i.length,o=Math.max(0,Math.min(a,i.length)),s=i.slice();return s.splice(o,0,r),{...e,order:s}},removeNode(e,t){let n=e.order.filter(e=>e!==t);return{...e,order:n}},removeNodes(e,t){if(t.length===0)return{...e,order:[...e.order]};let n=new Set(t),r=e.order.filter(e=>!n.has(e));return{...e,order:r}},reorderNode(e,t,n){let r=e.order,i=r.indexOf(t);if(i===-1)return e;let a=r.slice();a.splice(i,1);let o=Math.max(0,Math.min(n,r.length));return a.splice(o,0,t),{...e,order:a}}},c={selectNodes(e,t){return{...e,selection:{...e.selection,nodeIds:t}}},deselectNodes(e,t){let n=new Set(t),r=(e.selection.nodeIds??[]).filter(e=>!n.has(e));return{...e,selection:{...e.selection,nodeIds:r}}}},l=(e,t)=>{let{node:n,index:r,select:i}=t.payload,a=e;a=o.addNode(a,n);let s=String(n.id),l=a.order;if(!l.includes(s)){let e=r??l.length,t=Math.max(0,Math.min(e,l.length)),n=l.slice();n.splice(t,0,s),a={...a,order:n}}return i&&(a=c.selectNodes(a,[n.id])),a},u=(e,t)=>{let{nodeId:n}=t.payload;if(!e.nodes.has(n))return e;let r=e;return r=o.removeNode(r,n),r=s.removeNode(r,n),r=c.deselectNodes(r,[n]),r},d=(e,t)=>{let{nodeIds:n}=t.payload;if(n.length===0)return e;let r=e;return r=o.removeNodes(r,n),r=s.removeNodes(r,n),r=c.deselectNodes(r,n),r},f=(e,t)=>{let{nodeId:n,updates:r}=t.payload;if(!e.nodes.has(n))return e;let i=e.nodes.get(n);return!i||!Object.keys(r).some(e=>i[e]!==r[e])?e:o.updateNode(e,n,r)},p=(e,t)=>{let{nodeId:n,toIndex:r}=t.payload,i=s.reorderNode(e,n,r);return i===e?e:(i=c.deselectNodes(i,[n]),i)},m=(e,t)=>{let{nodeId:n}=t.payload;return c.selectNodes(e,[n])},h=(e,t)=>{let{nodeIds:n}=t.payload;return c.deselectNodes(e,n)},g={setZoom(e,t,n,r){if(t<=0)return e;let i=e.viewport;if(r!=null&&n!=null){let i=n.x-r.x/t,a=n.y-r.y/t;return{...e,viewport:{scale:t,x:i,y:a}}}if(n){let r=t/i.scale,a=n.x-(n.x-i.x)*r,o=n.y-(n.y-i.y)*r;return{...e,viewport:{scale:t,x:a,y:o}}}return{...e,viewport:{...i,scale:t}}},pan(e,t,n){let{viewport:r}=e;return{...e,viewport:{...r,x:r.x+t,y:r.y+n}}}},_=(e,t)=>{let{scale:n,center:r,pointer:i}=t.payload;return g.setZoom(e,n,r,i)},v=(e,t)=>{let{dx:n,dy:r}=t.payload;return g.pan(e,n,r)},y={ADD_NODE:l,REMOVE_NODE:u,REMOVE_NODES:d,UPDATE_NODE:f,REORDER:p,SELECT_NODE:m,DESELECT_NODES:h,SET_ZOOM:_,PAN_VIEWPORT:v};function b(e){return{version:1,nodes:Array.from(e.nodes.values()).map(e=>({id:e.id,type:e.type,geometry:e.geometry,state:e.state,style:e.style?{...e.style}:{}})),order:e.order,viewport:e.viewport}}function x(e,t){if(e.version!==1)throw Error(`Unsupported document version`);let n=new Map;for(let t of e.nodes)n.set(t.id,{id:t.id,type:t.type,geometry:t.geometry,state:t.state,style:t.style});return{...t,nodes:n,order:e.order,viewport:e.viewport?{...e.viewport}:t.viewport,selection:{nodeIds:[]},history:t.history}}function S(e){switch(e.version){case 1:return e;default:throw Error(`Unsupported document version`)}}var C=1;function w(e){return{version:C,nodes:Array.from(e.nodes.values()).map(e=>({id:e.id,type:e.type,geometry:e.geometry,state:e.state,style:e.style?{...e.style}:{}})),order:[...e.order],viewport:{...e.viewport},selection:{nodeIds:[...e.selection.nodeIds],...e.selection.primary!=null&&{primary:e.selection.primary}},history:{past:[...e.history.past],future:[...e.history.future]}}}function T(e){if(e.version!==1)throw Error(`Unsupported devtools snapshot version: ${e.version}`);let t=new Map;for(let n of e.nodes)t.set(n.id,{id:n.id,type:n.type,geometry:n.geometry,state:n.state,style:n.style??{}});return{nodes:t,order:[...e.order],viewport:{...e.viewport},selection:{nodeIds:[...e.selection.nodeIds],...e.selection.primary!=null&&{primary:e.selection.primary}},history:{past:[...e.history.past],future:[...e.history.future]}}}var E=100,D=0;function O(){return D+=1,`devtools-${D}-${Date.now()}`}function k(e={}){let t=e.maxLogSize??E,n=[],r=null;function i(e,r,i){let a=w(r),o={id:O(),timestamp:Date.now(),source:e,...i!=null&&{command:i},stateSnapshot:a};n.push(o),n.length>t&&n.splice(0,n.length-t)}let a=(e,t)=>{i(t==null?`replace`:`dispatch`,e,t)};function o(e){r=e}function s(){return[...n]}function c(e){return e<0||e>=n.length?null:n[e].stateSnapshot}function l(e){if(r==null)return;let t=c(e);if(t==null)return;let n=T(t);r.replaceState(n)}function u(){if(r==null)return`{}`;let e=w(r.getState());return JSON.stringify(e,null,2)}function d(){return Math.max(0,n.length-1)}return{logger:a,connect:o,getLog:s,getStateAt:c,replaceStateAt:l,exportStateJSON:u,getCurrentIndex:d}}exports.addNodeIntent=l,exports.createEditorDevTools=k,exports.createEditorEngine=a,exports.deserialize=x,exports.deserializeState=T,exports.intentMap=y,exports.migrate=S,exports.nodeOps=o,exports.orderOps=s,exports.removeNodeIntent=u,exports.reorderNodeIntent=p,exports.selectNodeIntent=m,exports.selectionOps=c,exports.serialize=b,exports.serializeState=w,exports.updateNodeIntent=f,exports.viewportOps=g;